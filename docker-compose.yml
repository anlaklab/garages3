version: "3.8"

services:
  garage:
    image: dxflrs/garage:v2.1.0
    container_name: garage
    restart: unless-stopped
    volumes:
      - ./garage.toml:/etc/garage.toml.template:ro
      - garage_meta:/var/lib/garage/meta
      - garage_data:/var/lib/garage/data
    environment:
      - GARAGE_ALLOW_WORLD_READABLE_SECRETS=true
      - RPC_SECRET=${RPC_SECRET}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        sed -e "s|__RPC_SECRET__|$$RPC_SECRET|g" \
            -e "s|__ADMIN_TOKEN__|$$ADMIN_TOKEN|g" \
            /etc/garage.toml.template > /etc/garage.toml
        exec /garage server
    ports:
      # S3 API - will be exposed via s3.anlak.es
      - "3900:3900"
      # RPC (internal communication)
      - "3901:3901"
      # Web/Static files - for static website hosting
      - "3902:3902"
      # Admin API (internal only)
      - "3903:3903"
    networks:
      - garage_network
    healthcheck:
      test: ["CMD", "/garage", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Garage WebUI - Admin dashboard
  # https://github.com/khairul169/garage-webui
  garage-webui:
    image: khairul169/garage-webui:latest
    container_name: garage-webui
    restart: unless-stopped
    environment:
      # Garage Admin API URL (internal docker network)
      - GARAGE_ADMIN_API=http://garage:3903
      # Admin token (must match garage.toml admin_token)
      - GARAGE_ADMIN_TOKEN=${ADMIN_TOKEN}
      # S3 API endpoint for the UI to use
      - GARAGE_S3_API=http://garage:3900
      # Region (must match garage.toml s3_region)
      - GARAGE_S3_REGION=garage
    ports:
      # WebUI - will be exposed via files.anlak.es
      - "3909:3909"
    networks:
      - garage_network
    depends_on:
      - garage

volumes:
  garage_meta:
    driver: local
  garage_data:
    driver: local

networks:
  garage_network:
    driver: bridge
